name: CI/CD - Scansible

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  release:
    types: [created]  # Déclenchement lors de la création d'un tag de release

jobs:
  build-and-test:
    name: 🔍 Lint & Tests
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout du code
        uses: actions/checkout@v3

      - name: 🏗️ Installation de Python et des dépendances
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: 📦 Installation des dépendances
        run: |
          python -m pip install --upgrade pip
          pip install -r requirement.txt
          pip install pytest flake8

      - name: 🔍 Vérification du code avec flake8
        run: flake8 .

      - name: ✅ Exécution des tests unitaires avec pytest
        run: pytest --junitxml=reports/test-results.xml

      - name: 📤 Archivage des rapports de test
        uses: actions/upload-artifact@v3
        with:
          name: test-reports
          path: reports/

  deploy:
    name: 🚀 Déploiement
    needs: build-and-test
    if: github.event_name == 'release' # Exécute seulement si une release est créée
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout du code
        uses: actions/checkout@v3

      - name: 📦 Création d'un package
        run: tar -cvf scansible.tar.gz .

      - name: 📤 Upload de l'archive en release GitHub
        uses: softprops/action-gh-release@v1
        with:
          files: scansible.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
