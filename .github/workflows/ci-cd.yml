name: CI/CD - Scansible

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  release:
    types: [created]  # DÃ©clenchement lors de la crÃ©ation d'un tag de release

jobs:
  build-and-test:
    name: ğŸ” Lint & Tests
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v3

      - name: ğŸ—ï¸ Installation de Python et des dÃ©pendances
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: ğŸ“¦ Installation des dÃ©pendances
        run: |
          python -m pip install --upgrade pip
          pip install -r requirement.txt
          pip install pytest flake8

      - name: ğŸ” VÃ©rification du code avec flake8
        run: flake8 .

      - name: âœ… ExÃ©cution des tests unitaires avec pytest
        run: pytest --junitxml=reports/test-results.xml

      - name: ğŸ“¤ Archivage des rapports de test
        uses: actions/upload-artifact@v3
        with:
          name: test-reports
          path: reports/

  deploy:
    name: ğŸš€ DÃ©ploiement
    needs: build-and-test
    if: github.event_name == 'release' # ExÃ©cute seulement si une release est crÃ©Ã©e
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v3

      - name: ğŸ“¦ CrÃ©ation d'un package
        run: tar -cvf scansible.tar.gz .

      - name: ğŸ“¤ Upload de l'archive en release GitHub
        uses: softprops/action-gh-release@v1
        with:
          files: scansible.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
